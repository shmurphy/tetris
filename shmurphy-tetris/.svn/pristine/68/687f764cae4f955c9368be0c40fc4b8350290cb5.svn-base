/*
 * TCSS 305
 * Assignment 6 - Tetris
 */
package gui;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;

import javax.swing.JFrame;
import javax.swing.JMenu;
import javax.swing.JMenuBar;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.Timer;

import model.Board;

/**
 * The GUI for Tetris.
 * 
 * @author Shannon Murphy
 * @version 6 March 2015
 */
public class TetrisGUI {
    
    /** The delay for the Timer. */
    private static final int TIMER_DELAY = 1000;
    
    /** A ToolKit. */
    private static final Toolkit KIT = Toolkit.getDefaultToolkit();
    
    /** The Dimension of the screen. */
    private static final Dimension SCREEN_SIZE = KIT.getScreenSize();
    
    /** The frame for the GUI. */
    private final JFrame myFrame;
    
    /** The Panel where the game is played. */
    private final GamePanel myGamePanel;
    
    /** The Board containing data about the game. */
    private final Board myBoard;
    
    /** The Timer that controls the game. */
    private Timer myTimer;
        
    /**
     * Constructs a new TetrisGUI.
     */
    public TetrisGUI() {
        myFrame = new JFrame("305");
        myBoard = new Board();
        createTimer();
        myGamePanel = new GamePanel(myBoard, myTimer); 
        createMenuBar();
    }
    
    /** Displays the GUI. */
    public void start() {
        myFrame.add(myGamePanel, BorderLayout.CENTER);
        myFrame.pack();
        myFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        myFrame.setLocation(SCREEN_SIZE.width / 2 - myFrame.getWidth() / 2,
                            SCREEN_SIZE.height / 2 - myFrame.getHeight() / 2);
        myFrame.setResizable(false);
        myFrame.setVisible(true);
        myFrame.addKeyListener(new MovePieceKeyListener());
    }
    
    /** Creates the Timer. */
    private void createTimer() {
        myTimer = new Timer(TIMER_DELAY, null);
        myTimer.start();
        myTimer.addActionListener(new ActionListener() {
            public void actionPerformed(final ActionEvent theEvent) {
                myBoard.step();
            }
        });
    }
    
    /**
     * Returns a String of the game controls and their functions.
     * To be displayed in the "Help" menu.
     * 
     * @return the game function and it's control.
     */
    public String getControls() {
        return "Move left: Left Arrow\n"
                + "Move right: Right Arrow\n"
                + "Move down: Down Arrow\n"
                + "Hard drop: Space Bar\n"
                + "Rotate clockwise: Up Arrow\n"
                + "Rotate counterclockwise: Ctrl\n";
    }
    
    /** Creates the menu bar for the GUI. */
    private void createMenuBar() {
        final JMenuBar menuBar = new JMenuBar();
        final JMenu fileMenu = createFileMenu();
        final JMenu helpMenu = createHelpMenu();
        menuBar.add(fileMenu);
        menuBar.add(helpMenu);
        myFrame.setJMenuBar(menuBar);
    }
    
    /** Creates the File menu for the GUI's MenuBar. 
     * 
     * @return a File menu with a new game feature.
     */
    private JMenu createFileMenu() {
        final JMenu fileMenu = new JMenu("File");
        final JMenuItem newGame = new JMenuItem("New Game");
        newGame.addActionListener(new ActionListener() {
            public void actionPerformed(final ActionEvent theEvent) {
                myBoard.clear();
                myGamePanel.setRestart(true);
            }
        });
        fileMenu.add(newGame);
        return fileMenu;
    }
    
    /** 
     * Creates the Help menu for the GUI's MenuBar.
     * Contains a "How to Play" menu item that displays the controls of the game.
     * 
     * @return a Help menu.
     */
    private JMenu createHelpMenu() {
        final JMenu helpMenu = new JMenu("Help");
        final JMenuItem controls = new JMenuItem("How to Play");
        controls.addActionListener(new ActionListener() {
            public void actionPerformed(final ActionEvent theEvent) {
                JOptionPane.showMessageDialog(myFrame,
                                              getControls(),
                                              "Controls",
                                              JOptionPane.INFORMATION_MESSAGE);
            }
        });
        helpMenu.add(controls);
        return helpMenu;
    }
    
    /**
     * Listens for keystrokes to move the current piece.
     */
    private class MovePieceKeyListener extends KeyAdapter {
        
        /**
         * Handles a key being typed.
         * 
         * @param theEvent The KeyEvent generated by the key.
         */
        public void keyPressed(final KeyEvent theEvent) {
            movePiece(theEvent);
        }
        
        /** 
         * Moves the current piece based on the key event. 
         * 
         * @param theEvent the KeyEvent typed by the user.
         */
        private void movePiece(final KeyEvent theEvent) {
            if (theEvent.getKeyCode() == KeyEvent.VK_LEFT) {
                myBoard.left();
            } else if (theEvent.getKeyCode() == KeyEvent.VK_RIGHT) {
                myBoard.right();
            } else if (theEvent.getKeyCode() == KeyEvent.VK_DOWN) {
                myBoard.down();
            } else if (theEvent.getKeyCode() == KeyEvent.VK_SPACE) {
                myBoard.drop();
            } else if (theEvent.getKeyCode() == KeyEvent.VK_UP) {
                myBoard.rotateCW();
            } else if (theEvent.getKeyCode() == KeyEvent.VK_CONTROL) {
                myBoard.rotateCCW();
            }
        }
    }
}
